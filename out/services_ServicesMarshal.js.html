<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/ServicesMarshal.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/ServicesMarshal.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Cote = require('cote');
const dev = require('./../utils/dev');
const servicesMapper = require("./ServicesMapper");
const { performance } = require('perf_hooks');
var Tasks = require("./tasks/Tasks");
var Users = require("./users/Users");
const SCRIPT_NAME = "\nServicesMarshal";
/*
	SERVICES MARSHAL
	RESPONSABLE FOR PROVIDING SERVICES CALLS
	THE PORTAL TO EACH SERVICE

	RECIEVES REQUEST FROM FRONT MARSHAL INCLUDING THE 
		REQUEST FROM FRONT END WITH A LIST OF SERVICES REQUESTS
	DISTRIBUTE CALLS TO EACH DESIRED SERVICE THEN COMPINE RESPONDS
		TO GIVE BACK TO FRONT MARSHAL

	RECIEVE REQUEST FROM ANY SERVICE THAT REQUESTS ACTION OR DATA FROM ANOTHER SERVICE/S

	CONTAINS VOTING SYSTEM
	CONTAINS ASYNCHRONOUS REQUEST FLOW ARF

	* MUST * RECIEVE A LIST CONTAINS SERVICES IDs AND DATA CORROSPONDING



	RECIEVED ENVELOPE: 

	services: [ // MUST BE envelope OWN PROPERTY
		{
			serviceID: "00000",
			data: {}
		}, ..
	]
	

	RESPONDING ENVELOPE:
		RECIEVED ENVELOPE WILL CONTAIN servicesResponds AS OWN PROPERTY, 
		WHILE REMOVING SENT services PROPERTY.

	servicesResponds: [
		{
			serviceID: "00000",
			data: {}
		}, ..
	]

*/




/**
 *  
 * @function isValidEnvelope - 
 * @param {*} envelope 
 */
function isValidEnvelope(envelope) {
    if (!envelope.hasOwnProperty("services")) {
        return false;
    } else if (!Array.isArray(envelope.services)) {
        return false;
    }
    return true;
}



// requires services list to be a first layer object in envelope
// 		services list item contains serviceID &amp; data
/*
	recieved envelope: 
		Same as sent by front end with EP attachedData
		{attachedData{}, services[]}

	roll in (services calls:
	sending services list's item to it's service.
	(dataSent, attachedData, next): dataSent: {servcieID, data}, next: (respond: {data}), data: {serviceID, status, data}), attachedData: backendData

	roll back: 
	envelope: { servicesResponds: [ {serviceID, status, data},.. ] }

*/
/*let servicesMap = new Map([
	[
		"00T", Tasks.reciever
	],
	[
		"00U", Users.reciever
	]
]);

servicesMap.set("00T", Tasks.reciever);
servicesMap.set("00U", Users.reciever);

function getServiceReciever (serviceID) {
	if (serviceID == "00T") return Tasks.reciever;
	if (serviceID == "00U") return Users.reciever;
}*/

exports.reciever = (envelope, next) => {
    // validating envelope
    if (!isValidEnvelope(envelope)) {
        envelope["err"] = "SERVICES MARSHAL: not valid envelope";
        next(envelope);
        return;
    }



    let servicesResponds = [];
    //AU	let affectedUsers = [];

    // voting system, goal is the min number of responds before next().
    let GOAL = envelope.services.length;
    let votes = 0;



    // TODO: COMPLETE SERVICES MARSHAL VOTING SYSTEM CONSIDERING RESPONDS INTEGRATION.

    let startTime = performance.now();
    try {
        for (serviceData of envelope.services) {
            // retireve reciever function for this service and call it
            //service = servicesMapper.getServiceReciever(serviceData.serviceID);
            servicesMapper.getServiceReciever(serviceData.serviceID.substring(0, 3))(
                serviceData, // data sent to the service
                envelope.attachedData,
                postServiceResponse // next called by the service
            );

        }
    } catch (err) { // TODO: ** CHECK AND IMPLEMENT THE VALID RESPOND IF SOMETHING WENT WRONG LIKE SERVICE ID IS NOT DEFINED
        console.log(SCRIPT_NAME + " ERROR INVALID SERVICES OBJECT")
        next({
            status: 'FAILED',
            data: "Error, services object is not valid"
        })
    }



    function postServiceResponse(respond) {
        // append respond.
        servicesResponds.push({
            serviceID: respond.serviceID,
            status: respond.status,
            data: respond.data
        });

        /*AU
        		// affected users // INCOMPLETE.
        		if (respond.status == "SUCCESS") {
        			if (respond.hasOwnProperty ("affectedUsers")) {
        				affectedUsers.push (...respond.affectedUsers);
        				delete respond.affectedUsers;
        			}
        		}
        */


        // voting system.
        if (++votes >= GOAL) {

            delete envelope.services;

            envelope["servicesResponds"] = servicesResponds; // responds

            /*AU
            			if (affectedUsers.length != 0) {
            				envelope["affectedUsers"] = affectedUsers; // affected users
            			}
            */
            // time taken for all the services to respond  voting time in milliSeconds
            envelope["Monitor"] = { sm_vt: (performance.now() - startTime).toFixed(2) + "ms" }; // monitor

            /*			console.log (SCRIPT_NAME + ": final envelope after voting: " + JSON.stringify(envelope));
             */
            next(envelope);

        }

    }

}

/**
 * @function reciever - services/
 * @param {*} envelope 
 * @param {*} next 
 */
exports.reciever = (envelope, next) => {
    // validating envelope
    if (!isValidEnvelope(envelope)) {
        envelope["err"] = "SERVICES MARSHAL: not valid envelope";
        next(envelope);
        return;
    }



    let servicesResponds = [];
    //AU	let affectedUsers = [];

    // voting system, goal is the min number of responds before next().
    let GOAL = envelope.services.length;
    let votes = 0;


    // TODO: COMPLETE SERVICES MARSHAL VOTING SYSTEM CONSIDERING RESPONDS INTEGRATION.
    /**
     * TODO: COMPLETE SERVICES MARSHAL VOTING SYSTEM CONSIDERING RESPONDS INTEGRATION.
     * @callback
     */
    let startTime = performance.now();
    try {
        for (serviceData of envelope.services) {
            // retireve reciever function for this service and call it
            //service = servicesMapper.getServiceReciever(serviceData.serviceID);
            servicesMapper.getServiceReciever(serviceData.serviceID.substring(0, 3))(
                serviceData, // data sent to the service
                envelope.attachedData,
                postServiceResponse // next called by the service
            );

        }
    } catch (err) { // TODO: ** CHECK AND IMPLEMENT THE VALID RESPOND IF SOMETHING WENT WRONG LIKE SERVICE ID IS NOT DEFINED
        console.log(SCRIPT_NAME + " ERROR INVALID SERVICES OBJECT")
        next({
            status: 'FAILED',
            data: "Error, services object is not valid"
        })
    }


    /**
     * @function postServiceResponse
     * @param {*} respond 
     */
    function postServiceResponse(respond) {
        // append respond.
        servicesResponds.push({
            serviceID: respond.serviceID,
            status: respond.status,
            data: respond.data
        });

        /*AU
        		// affected users // INCOMPLETE.
        		if (respond.status == "SUCCESS") {
        			if (respond.hasOwnProperty ("affectedUsers")) {
        				affectedUsers.push (...respond.affectedUsers);
        				delete respond.affectedUsers;
        			}
        		}
        */


        // voting system.
        if (++votes >= GOAL) {

            delete envelope.services;

            envelope["servicesResponds"] = servicesResponds; // responds

            /*AU
            			if (affectedUsers.length != 0) {
            				envelope["affectedUsers"] = affectedUsers; // affected users
            			}
            */
            // time taken for all the services to respond  voting time in milliSeconds
            envelope["Monitor"] = { sm_vt: (performance.now() - startTime).toFixed(2) + "ms" }; // monitor

            /*			console.log (SCRIPT_NAME + ": final envelope after voting: " + JSON.stringify(envelope));
             */
            next(envelope);

        }

    }

}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Document.html">Document</a></li><li><a href="Field.html">Field</a></li><li><a href="Socket.html">Socket</a></li></ul><h3>Events</h3><ul><li><a href="click%2520-%2520selected%2520est.html#.event:infiltertaskslist"> in filter tasks list</a></li><li><a href="global.html#event:change-projectfilterlist">change - project filter list</a></li><li><a href="global.html#event:change-handlingmultiselectfornewtask">change -handling multi select for newtask</a></li><li><a href="global.html#event:change-overdueintaskslist">change -overdue in tasks list</a></li><li><a href="global.html#event:click-ifprojectBasedcategorytasksettingischecked">click -  if projectBased category task setting is checked</a></li><li><a href="global.html#event:click-ifpubliccategorytasksettingischecked">click -  if public category task setting is checked</a></li><li><a href="global.html#event:click-closetaskviewmodal">click - close task view modal</a></li><li><a href="global.html#event:click-ifpublicprojecttasksettingischecked">click - if public project task setting is checked</a></li><li><a href="global.html#event:click-paginationfortaskslist">click - pagination for tasks list</a></li><li><a href="global.html#event:click-paginationlogrecord">click - pagination log record</a></li><li><a href="global.html#event:click-subtasksaddedinnewtaskform">click - subtasks added in new task form</a></li><li><a href="global.html#event:EncryptionResponder">EncryptionResponder</a></li><li><a href="global.html#event:submit-addsubtask">submit - add subtask</a></li><li><a href="global.html#event:submit-submitlogform">submit - submit log form</a></li><li><a href="global.html#event:submit-submittaskafteredit">submit - submit task after edit</a></li><li><a href="global.html#event:submit-sendtasksfilterobj">submit -send tasks filter obj</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addLocationIfNew">addLocationIfNew</a></li><li><a href="global.html#addNewCategory-sentcategoryobjecttothisfunction">addNewCategory - sent category object to this function</a></li><li><a href="global.html#addNewProject-sentprojectobjecttothisfunction">addNewProject - sent project object to this function</a></li><li><a href="global.html#cachedUsers">cachedUsers</a></li><li><a href="global.html#clearNewTaskInputs">clearNewTaskInputs</a></li><li><a href="global.html#clearNewTaskInputs-clearnewtasksinputs">clearNewTaskInputs - clear new tasks inputs</a></li><li><a href="global.html#comments">comments</a></li><li><a href="global.html#dataToSend">dataToSend</a></li><li><a href="global.html#deleteSubTaskS">deleteSubTaskS</a></li><li><a href="global.html#editTask">editTask</a></li><li><a href="global.html#EditTaskModal">EditTaskModal</a></li><li><a href="global.html#fillEditTaskForm">fillEditTaskForm</a></li><li><a href="global.html#fillLogRecordTable">fillLogRecordTable</a></li><li><a href="global.html#fillNewTaskPreData">fillNewTaskPreData</a></li><li><a href="global.html#fillOutputsOfTaskView">fillOutputsOfTaskView</a></li><li><a href="global.html#fillPreData">fillPreData</a></li><li><a href="global.html#fillSubTasksList">fillSubTasksList</a></li><li><a href="global.html#fillTableLogForSubTask">fillTableLogForSubTask</a></li><li><a href="global.html#fillTableOfLogProgress-filltableoflogprogress">fillTableOfLogProgress - fill table of log progress</a></li><li><a href="global.html#fillTaskLogProgressData">fillTaskLogProgressData</a></li><li><a href="global.html#fillTasksListTable">fillTasksListTable</a></li><li><a href="global.html#fillTasksSettingsPreData">fillTasksSettingsPreData</a></li><li><a href="global.html#getCommentsList">getCommentsList</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#GetFilteredData">GetFilteredData</a></li><li><a href="global.html#GetFilteredDataLogRecord">GetFilteredDataLogRecord</a></li><li><a href="global.html#getFilterObject">getFilterObject</a></li><li><a href="global.html#getIDsAndValuesFormAnyForm">getIDsAndValuesFormAnyForm</a></li><li><a href="global.html#getServiceReciever">getServiceReciever</a></li><li><a href="global.html#GETspecificTask">GETspecificTask</a></li><li><a href="global.html#getTasksIDAndName">getTasksIDAndName</a></li><li><a href="global.html#getTasksStatesPreData">getTasksStatesPreData</a></li><li><a href="global.html#getTaskStates">getTaskStates</a></li><li><a href="global.html#getUsers">getUsers</a></li><li><a href="global.html#getUsersIdentifiers">getUsersIdentifiers</a></li><li><a href="global.html#insertComment">insertComment</a></li><li><a href="global.html#insertLogProgress">insertLogProgress</a></li><li><a href="global.html#insertLogRecord">insertLogRecord</a></li><li><a href="global.html#insertNewState">insertNewState</a></li><li><a href="global.html#isValidEnvelope-">isValidEnvelope -</a></li><li><a href="global.html#loadLogRecordFirstTime">loadLogRecordFirstTime</a></li><li><a href="global.html#loadNewTaskData-getpreDataofnewtasktofilllistsinnewtaskform">loadNewTaskData - get preData of new task to fill lists in new task form</a></li><li><a href="global.html#loadTasksFirstTime">loadTasksFirstTime</a></li><li><a href="global.html#missingProperties">missingProperties</a></li><li><a href="global.html#postServiceResponse">postServiceResponse</a></li><li><a href="global.html#preHomeAuth-HOMEPAGESERVING">preHomeAuth -HOME PAGE SERVING</a></li><li><a href="global.html#reciever">reciever</a></li><li><a href="global.html#reciever-services/">reciever - services/</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#respondsCallbacks">respondsCallbacks</a></li><li><a href="global.html#retrieveEditTaskInputs">retrieveEditTaskInputs</a></li><li><a href="global.html#retrieveNewTaskInputs">retrieveNewTaskInputs</a></li><li><a href="global.html#servicesRequests">servicesRequests</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#statesPreData">statesPreData</a></li><li><a href="global.html#submitNewComment">submitNewComment</a></li><li><a href="global.html#submitNewTask-newtaskobjectwillbesenttoit">submitNewTask - new task object will be sent to it</a></li><li><a href="global.html#taskContainsSubtask">taskContainsSubtask</a></li><li><a href="global.html#taskNewState">taskNewState</a></li><li><a href="global.html#tasksLogsRecordsFilter">tasksLogsRecordsFilter</a></li><li><a href="global.html#tasksPreData">tasksPreData</a></li><li><a href="global.html#taskStates">taskStates</a></li><li><a href="global.html#userAssignedTasks">userAssignedTasks</a></li><li><a href="global.html#userTasks">userTasks</a></li><li><a href="global.html#verifyUser">verifyUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Thu Mar 18 2021 16:55:02 GMT+0200 (Eastern European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
